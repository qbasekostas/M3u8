name: Daily Referer & Origin Updater (Browser Emulation)

on:
  schedule:
    - cron: '30 5 * * *' # Αλλάχθηκε λίγο για να μην τρέχει ακριβώς την ίδια ώρα με άλλους
  workflow_dispatch:

jobs:
  update-referer:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ΝΕΟ ΒΗΜΑ: Εγκατάσταση του Node.js που απαιτείται για την προσομοίωση browser
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # ΤΟ ΚΡΙΣΙΜΟ ΒΗΜΑ: Χρήση browser για την εύρεση του URL
      - name: Fetch new Referer using a headless browser
        id: fetch_referer # Δίνουμε ένα ID στο βήμα για να πάρουμε το αποτέλεσμά του αργότερα
        run: |
          SOURCE_PAGE_URL="https://miztv.top/stream/stream-622.php"
          echo "Installing Puppeteer..."
          npm i puppeteer
          
          echo "Launching browser to fetch dynamic content from $SOURCE_PAGE_URL"

          # Αυτό είναι ένα μικρό Node.js script που χρησιμοποιεί το Puppeteer
          # για να βρει το Referer και να το στείλει ως "output" του βήματος.
          NEW_REFERER_URL=$(node -e "
            const puppeteer = require('puppeteer');
            (async () => {
              const browser = await puppeteer.launch({ args: ['--no-sandbox', '--disable-setuid-sandbox'] });
              const page = await browser.newPage();
              try {
                await page.goto('${SOURCE_PAGE_URL}', { waitUntil: 'networkidle2', timeout: 30000 });
                // Περιμένουμε μέχρι το iframe που περιέχει το video player να εμφανιστεί
                await page.waitForSelector('iframe');
                const pageContent = await page.content();
                const match = pageContent.match(/Referer=([^&]+)/);
                if (match && match[1]) {
                  console.log(match[1]); // Τυπώνουμε το αποτέλεσμα για να το πιάσει η bash
                }
              } catch (e) {
                console.error('Error fetching page with Puppeteer:', e.message);
              } finally {
                await browser.close();
              }
            })();
          ")

          if [ -z "\$NEW_REFERER_URL" ]; then
            echo "::error::Could not find new Referer URL even with a browser. The website structure might have changed."
            exit 1
          fi

          echo "Successfully found new Referer: \$NEW_REFERER_URL"
          # Ορίζουμε το output για να το χρησιμοποιήσουν τα επόμενα βήματα
          echo "new_referer=\$NEW_REFERER_URL" >> \$GITHUB_OUTPUT

      # Ενημέρωση του αρχείου M3U8 με βάση το αποτέλεσμα του προηγούμενου βήματος
      - name: Update M3U8 file with new Referer
        run: |
          TARGET_FILE="GreekSportsChannels.m3u8"
          NEW_REFERER_URL="${{ steps.fetch_referer.outputs.new_referer }}"
          
          echo "New Referer to use for update is: \$NEW_REFERER_URL"
          
          CURRENT_REFERER_URL=\$(grep -oP 'Referer=\\K[^&]+' "\$TARGET_FILE" | head -n 1)

          if [ -z "\$CURRENT_REFERER_URL" ]; then
            echo "::warning::No current Referer found. Appending to all links."
            sed -i -E "s|(dokko1new.newkso.ru/dokko1/premium[0-9]+/mono.m3u8)|\\1#Referer=\${NEW_REFERER_URL}\\&Origin=\${NEW_REFERER_URL}|g" "\$TARGET_FILE"
            exit 0
          fi

          if [ "\$NEW_REFERER_URL" == "\$CURRENT_REFERER_URL" ]; then
            echo "Referer is already up-to-date."
            exit 0
          fi

          echo "Updating all links in \$TARGET_FILE"
          sed -i "s|\$CURRENT_REFERER_URL|\$NEW_REFERER_URL|g" "\$TARGET_FILE"
          echo "File updated successfully."

      # Commit και push των αλλαγών
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ci: Automate update of Referer/Origin URL (via browser)'
          commit_user_name: 'GitHub Actions Bot'
          commit_user_email: 'actions@github.com'
          commit_author: 'GitHub Actions Bot <actions@github.com>'
          file_pattern: 'GreekSportsChannels.m3u8'
