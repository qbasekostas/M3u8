name: Daily URL Updater (Guaranteed to Work)

on:
  schedule:
    - cron: '0 8 * * *' # Εκτέλεση μία φορά την ημέρα
  workflow_dispatch: # Για χειροκίνητη εκτέλεση

jobs:
  update-urls:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Απαραίτητο για να μπορεί το Action να κάνει commit

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Fetch New URL and Rebuild M3U8 File
        run: |
          TARGET_FILE="GreekSportsChannels.m3u8"

          # --- Εύρεση του Νέου URL-Βάση ---
          SOURCE_PAGE_URL="https://miztv.top/stream/stream-622.php"
          echo "Installing Puppeteer..."
          npm i puppeteer --silent > /dev/null 2>&1
          
          echo "Launching browser to find the new base URL..."
          NEW_BASE_URL=$(node -e "
            const puppeteer = require('puppeteer');
            (async () => {
              const browser = await puppeteer.launch({ args: ['--no-sandbox', '--disable-setuid-sandbox'] });
              const page = await browser.newPage();
              try {
                await page.goto('${SOURCE_PAGE_URL}', { waitUntil: 'domcontentloaded', timeout: 30000 });
                await page.waitForSelector('iframe', { timeout: 15000 });
                const iframeSrc = await page.evaluate(() => document.querySelector('iframe').src);
                if (iframeSrc) {
                  const url = new URL(iframeSrc);
                  console.log(url.origin + '/');
                }
              } catch (e) {
                // Return empty on failure
              } finally {
                await browser.close();
              }
            })();
          ")

          if [ -z "$NEW_BASE_URL" ]; then
            echo "::error::Could not extract the new Referer/Origin URL from the source page."
            exit 1
          fi
          echo "Successfully found new base URL: $NEW_BASE_URL"
          
          # --- ΟΡΙΣΤΙΚΗ ΑΝΤΙΚΑΤΑΣΤΑΣΗ ---
          echo "Rebuilding all URL lines in $TARGET_FILE..."
          
          # Η ΕΓΓΥΗΜΕΝΗ ΕΝΤΟΛΗ:
          # Για κάθε γραμμή που τελειώνει σε .m3u8 (με ή χωρίς #... μετά),
          # ξαναχτίζει το τέλος της γραμμής από την αρχή.
          # Το (\1) είναι το κομμάτι του URL μέχρι και το .m3u8.
          sed -i -E "s|^(https?://.*\.m3u8)(#.*)?$|\1#Referer=${NEW_BASE_URL}&Origin=${NEW_BASE_URL}|" "$TARGET_FILE"
          
          echo "File updated successfully."

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ci: Automate update of stream URLs'
          commit_user_name: 'GitHub Actions Bot'
          commit_user_email: 'actions@github.com'
          commit_author: 'GitHub Actions Bot <actions@github.com>'
          file_pattern: 'GreekSportsChannels.m3u8'
