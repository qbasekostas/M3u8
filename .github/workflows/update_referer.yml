name: Fully Automatic Referer Updater (DrewLive Method)

on:
  schedule:
    - cron: '0 0 * * *' # Μία φορά τα μεσάνυχτα
  workflow_dispatch:

jobs:
  update-links:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch new Referer and update M3U8
        id: update_step
        run: |
          # Ορίζουμε το αρχείο-στόχο
          TARGET_FILE="GreekSportsChannels.m3u8"
          
          # Βρίσκουμε τον παλιό referer από το αρχείο μας για να ξέρουμε τι να αλλάξουμε
          OLD_REFERER=$(grep -oP 'Referer=\K[^&]+' "$TARGET_FILE" | head -n 1)
          if [ -z "$OLD_REFERER" ]; then
            echo "::error::Could not find OLD_REFERER in the file. Aborting."
            exit 1
          fi
          echo "Current Referer in file is: $OLD_REFERER"

          # --- Η ΜΑΓΕΙΑ ΕΙΝΑΙ ΕΔΩ ---
          # 1. Πηγαίνουμε στο embed URL του πρώτου καναλιού (622) για να βρούμε το token
          EMBED_URL="https://allupplay.xyz/embed.php?id=stream-622&token=null&t=0"
          
          # 2. Παίρνουμε το περιεχόμενο και εξάγουμε το token από τη γραμμή που λέει "data: {"
          TOKEN=$(curl -s -L "$EMBED_URL" | grep -oP "data: .*?\K{[^}]+}" | grep -oP '"token":\s*"\K[^"]+')
          
          if [ -z "$TOKEN" ]; then
            echo "::error::Failed to extract TOKEN from embed page."
            exit 1
          fi
          echo "Found new Token: $TOKEN"

          # 3. Κάνουμε το ίδιο request που κάνει το site για να πάρουμε το νέο Referer
          # Στέλνουμε ένα ψεύτικο Referer, όπως κάνει το script του DrewLive
          # Το αποτέλεσμα θα είναι ένα JSON που περιέχει το πραγματικό URL του stream
          API_RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/x-www-form-urlencoded; charset=UTF-8" \
            -H "X-Requested-With: XMLHttpRequest" \
            -H "Referer: $EMBED_URL" \
            --data-urlencode "id=stream-622" \
            --data-urlencode "token=$TOKEN" \
            "https://allupplay.xyz/get.php")

          # 4. Εξάγουμε το νέο Referer από το τελικό URL μέσα στο JSON
          NEW_REFERER=$(echo "$API_RESPONSE" | grep -oP 'Referer=\K[^&]+')

          if [ -z "$NEW_REFERER" ]; then
            echo "::error::Failed to extract NEW_REFERER from API response. Response was: $API_RESPONSE"
            exit 1
          fi
          echo "Found new Referer from API: $NEW_REFERER"

          # Έλεγχος αν χρειάζεται αλλαγή
          if [ "$OLD_REFERER" == "$NEW_REFERER" ]; then
            echo "Referer is already up-to-date. No changes needed."
            # Ορίζουμε μια μεταβλητή για να ξέρει το επόμενο βήμα να μην κάνει commit
            echo "changes_made=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Αντικατάσταση του παλιού με το νέο
          echo "Replacing '$OLD_REFERER' with '$NEW_REFERER'..."
          sed -i "s|$OLD_REFERER|$NEW_REFERER|g" "$TARGET_FILE"
          echo "File updated successfully."
          echo "changes_made=true" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        # Τρέχει μόνο αν το προηγούμενο βήμα όρισε το changes_made σε true
        if: steps.update_step.outputs.changes_made == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ci: ✨ Automate update of Referer/Origin URL (DrewLive Method)'
          commit_user_name: 'GitHub Actions Bot'
          commit_user_email: 'actions@github.com'
          commit_author: 'GitHub Actions Bot <actions@github.com>'
          file_pattern: 'GreekSportsChannels.m3u8'
