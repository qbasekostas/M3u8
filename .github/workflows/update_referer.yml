name: Daily Referer & Origin Updater (Final)

on:
  schedule:
    - cron: '45 5 * * *' # Αλλάζουμε την ώρα για να μην έχουμε θέματα
  workflow_dispatch:

jobs:
  update-referer:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Fetch new Referer by extracting Iframe Origin
        id: fetch_referer
        run: |
          SOURCE_PAGE_URL="https://miztv.top/stream/stream-622.php"
          echo "Installing Puppeteer..."
          npm i puppeteer
          
          echo "Launching browser to find the iframe source URL..."

          # Τελικό Node.js script: Βρίσκει το iframe και εξάγει το origin του.
          NEW_REFERER_URL=$(node -e "
            const puppeteer = require('puppeteer');
            (async () => {
              const browser = await puppeteer.launch({ args: ['--no-sandbox', '--disable-setuid-sandbox'] });
              const page = await browser.newPage();
              try {
                await page.goto('${SOURCE_PAGE_URL}', { waitUntil: 'domcontentloaded', timeout: 30000 });
              } catch (e) {
                console.warn('Page navigation may have timed out, but proceeding to find iframe.');
              }
              
              try {
                await page.waitForSelector('iframe', { timeout: 15000 });
                const iframeSrc = await page.evaluate(() => document.querySelector('iframe').src);

                if (iframeSrc) {
                  const url = new URL(iframeSrc);
                  // Εξάγουμε το origin (π.χ. https://allupplay.xyz) και προσθέτουμε την κάθετο
                  const newReferer = url.origin + '/';
                  console.log(newReferer); // Αυτό είναι το αποτέλεσμα που θέλουμε!
                } else {
                  console.error('Iframe found, but its src attribute is empty.');
                }
              } catch(e) {
                console.error('Could not find iframe on the page within the time limit.');
              } finally {
                await browser.close();
              }
            })();
          ")

          if [ -z "\$NEW_REFERER_URL" ]; then
            echo "::error::Could not extract the new Referer/Origin URL."
            exit 1
          fi

          echo "Successfully extracted new Referer/Origin: \$NEW_REFERER_URL"
          echo "new_referer=\$NEW_REFERER_URL" >> \$GITHUB_OUTPUT

      - name: Update M3U8 file with new Referer
        env:
          NEW_REFERER_URL: ${{ steps.fetch_referer.outputs.new_referer }}
        run: |
          TARGET_FILE="GreekSportsChannels.m3u8"
          
          if [ -z "\$NEW_REFERER_URL" ]; then
            echo "::error::New Referer URL from previous step is empty. Aborting."
            exit 1
          fi

          echo "Using new Referer/Origin for update: \$NEW_REFERER_URL"
          
          # Χρησιμοποιούμε ένα προσωρινό, ασφαλές διαχωριστικό για το sed
          DELIMITER=\$(openssl rand -hex 8)
          
          # Παίρνουμε τον παλιό referer
          CURRENT_REFERER_URL=\$(grep -oP 'Referer=\\K[^&]+' "\$TARGET_FILE" | head -n 1)

          if [ -z "\$CURRENT_REFERER_URL" ]; then
            echo "::warning::No current Referer found. Appending to all links."
            sed -i -E "s\${DELIMITER}(dokko1new.newkso.ru/dokko1/premium[0-9]+/mono.m3u8)\${DELIMITER}\\1#Referer=\${NEW_REFERER_URL}\\&Origin=\${NEW_REFERER_URL}\${DELIMITER}g" "\$TARGET_FILE"
            exit 0
          fi

          if [ "\$NEW_REFERER_URL" == "\$CURRENT_REFERER_URL" ]; then
            echo "Referer is already up-to-date."
            exit 0
          fi

          echo "Updating all links in \$TARGET_FILE"
          sed -i "s\${DELIMITER}\$CURRENT_REFERER_URL\${DELIMITER}\$NEW_REFERER_URL\${DELIMITER}g" "\$TARGET_FILE"
          echo "File updated successfully."

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ci: Automate update of Referer/Origin URL'
          commit_user_name: 'GitHub Actions Bot'
          commit_user_email: 'actions@github.com'
          commit_author: 'GitHub Actions Bot <actions@github.com>'
          file_pattern: 'GreekSportsChannels.m3u8'
