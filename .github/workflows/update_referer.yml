name: Streamlink CSS Updater for Enigma2

on:
  schedule:
    - cron: '0 */4 * * *' # Τρέχει κάθε 4 ώρες γιατί το token λήγει
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install requests

      - name: Extract Auth Data
        id: auth
        run: |
          RAW_DATA=$(python find_and_auth.py)
          TOKEN=$(echo $RAW_DATA | cut -d'|' -f1)
          REFERER=$(echo $RAW_DATA | cut -d'|' -f2)
          ORIGIN=$(echo $RAW_DATA | cut -d'|' -f3)
          
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          echo "referer=$REFERER" >> $GITHUB_OUTPUT
          echo "origin=$ORIGIN" >> $GITHUB_OUTPUT

      - name: Rebuild M3U8 for OS Mio 4K
        env:
          TOKEN: ${{ steps.auth.outputs.token }}
          REFERER: ${{ steps.auth.outputs.referer }}
          ORIGIN: ${{ steps.auth.outputs.origin }}
        run: |
          TARGET_FILE="GreekSportsChannels.m3u8"
          TEMP_FILE="temp.m3u8"
          
          # Ξεκινάμε το αρχείο
          echo "#EXTM3U" > $TEMP_FILE

          # Λίστα καναλιών (ID και Όνομα)
          # Μπορείς να προσθέσεις όσα θες εδώ
          declare -A channels
          channels=( 
            ["premium622"]="Cosmote Sport 1 HD"
            ["premium623"]="Cosmote Sport 2 HD"
            ["premium624"]="Cosmote Sport 3 HD"
            ["premium625"]="Cosmote Sport 4 HD"
            ["premium626"]="Cosmote Sport 5 HD"
            ["premium638"]="Nova Sports Prime HD"
            ["premium631"]="Nova Sports 1 HD"
          )

          for id in "${!channels[@]}"; do
            NAME="${channels[$id]}"
            
            # Κατασκευή του URL για το Streamlink 8088 του δέκτη
            # Χρησιμοποιούμε kiko2.ru που είναι το νέο domain
            BASE_URL="http://127.0.0.1:8088/https://dokko1new.kiko2.ru/dokko1/${id}/mono.css"
            
            # Προσθήκη των Headers με τη σύνταξη που καταλαβαίνει ο δέκτης σου
            HEADERS=" -http-header=Origin=${ORIGIN} -http-header=Referer=${REFERER} -http-header=X-Channel-Key=${id} -http-header=Authorization=Bearer+${TOKEN}"
            
            echo "#EXTINF:-1,${NAME}" >> $TEMP_FILE
            echo "${BASE_URL}${HEADERS}" >> $TEMP_FILE
          done

          mv $TEMP_FILE $TARGET_FILE

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'Updated Tokens and CSS links'
          file_pattern: 'GreekSportsChannels.m3u8'
