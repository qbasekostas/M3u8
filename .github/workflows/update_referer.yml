name: Daily Referer & Origin Updater (All-In-One)

on:
  schedule:
    - cron: '15 6 * * *'
  workflow_dispatch:

jobs:
  update-referer:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Fetch Referer and Update File
        run: |
          # --- Βήμα 1: Εύρεση του νέου Referer ---
          SOURCE_PAGE_URL="https://miztv.top/stream/stream-622.php"
          echo "Installing Puppeteer..."
          npm i puppeteer --silent > /dev/null 2>&1
          
          echo "Launching browser to find the iframe source URL..."

          NEW_REFERER_URL=$(node -e "
            const puppeteer = require('puppeteer');
            (async () => {
              const browser = await puppeteer.launch({ args: ['--no-sandbox', '--disable-setuid-sandbox'] });
              const page = await browser.newPage();
              try {
                await page.goto('${SOURCE_PAGE_URL}', { waitUntil: 'domcontentloaded', timeout: 30000 });
                await page.waitForSelector('iframe', { timeout: 15000 });
                const iframeSrc = await page.evaluate(() => document.querySelector('iframe').src);
                if (iframeSrc) {
                  const url = new URL(iframeSrc);
                  console.log(url.origin + '/');
                }
              } catch (e) {
                // Do nothing, let it return empty
              } finally {
                await browser.close();
              }
            })();
          ")

          if [ -z "$NEW_REFERER_URL" ]; then
            echo "::error::Could not extract the new Referer/Origin URL."
            exit 1
          fi

          echo "Successfully extracted new Referer/Origin: $NEW_REFERER_URL"

          # --- Βήμα 2: Ενημέρωση του αρχείου M3U8 (μέσα στο ίδιο step) ---
          TARGET_FILE="GreekSportsChannels.m3u8"
          CURRENT_REFERER_URL=$(grep -oP 'Referer=\K[^&]+' "$TARGET_FILE" | head -n 1)

          if [ -z "$CURRENT_REFERER_URL" ]; then
            echo "::warning::No current Referer found. Appending to all links."
            sed -i -E "s|(dokko1new.newkso.ru/dokko1/premium[0-9]+/mono.m3u8)|\\1#Referer=${NEW_REFERER_URL}\&Origin=${NEW_REFERER_URL}|g" "$TARGET_FILE"
          elif [ "$NEW_REFERER_URL" != "$CURRENT_REFERER_URL" ]; then
            echo "Updating all links in $TARGET_FILE"
            # Χρησιμοποιούμε το # ως διαχωριστικό στο sed για ασφάλεια με τα URL
            sed -i "s#$CURRENT_REFERER_URL#$NEW_REFERER_URL#g" "$TARGET_FILE"
            echo "File updated successfully."
          else
            echo "Referer is already up-to-date. No changes needed."
          fi

      - name: Commit and push changes
        if: success() # Τρέχει μόνο αν το προηγούμενο βήμα ήταν επιτυχές
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ci: Automate update of Referer/Origin URL'
          commit_user_name: 'GitHub Actions Bot'
          commit_user_email: 'actions@github.com'
          commit_author: 'GitHub Actions Bot <actions@github.com>'
          file_pattern: 'GreekSportsChannels.m3u8'
