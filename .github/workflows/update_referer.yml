name: Fully Automatic Final Updater (Safe Rebuild Method)

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Find new Referer
        id: find_auth
        run: |
          NEW_REFERER=$(python find_and_auth.py)
          echo "new_referer_url=$NEW_REFERER" >> $GITHUB_OUTPUT

      - name: Safely Rebuild M3U8 File
        env:
          NEW_URL: ${{ steps.find_auth.outputs.new_referer_url }}
        run: |
          TARGET_FILE="GreekSportsChannels.m3u8"
          TEMP_FILE="temp_new.m3u8"
          
          if [ -z "$NEW_URL" ]; then
            echo "::error::The new URL found is empty. Aborting."
            exit 1
          fi

          # Διαβάζουμε το αρχικό αρχείο γραμμή-γραμμή
          while IFS= read -r line; do
            # Ελέγχουμε αν η γραμμή είναι URL
            if [[ "$line" == "https://"* ]]; then
              # Κόβουμε το URL μέχρι το .m3u8
              BASE_URL=$(echo "$line" | grep -oP '^https?://.*?\.m3u8')
              # Κατασκευάζουμε τη νέα, σωστή γραμμή
              NEW_LINE="${BASE_URL}#Referer=${NEW_URL}&Origin=${NEW_URL}"
              echo "$NEW_LINE" >> "$TEMP_FILE"
            else
              # Αν δεν είναι URL (π.χ. #EXTINF), απλά την αντιγράφουμε ως έχει
              echo "$line" >> "$TEMP_FILE"
            fi
          done < "$TARGET_FILE"

          # Αντικαθιστούμε το παλιό αρχείο με το νέο, προσωρινό
          mv "$TEMP_FILE" "$TARGET_FILE"
          
          echo "File rebuilt successfully with new Referer and Origin."

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ci: ✨ Rebuild M3U8 with updated Referer/Origin'
          file_pattern: 'GreekSportsChannels.m3u8'
