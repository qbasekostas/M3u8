name: Daily Referer & Origin Updater (Correct Logic)

on:
  schedule:
    - cron: '30 6 * * *'
  workflow_dispatch:

jobs:
  update-referer:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Απαραίτητο για να μπορεί το Action να κάνει commit

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Fetch Referer and Update File
        run: |
          # --- Βήμα 1: Εύρεση του νέου URL-βάση ---
          SOURCE_PAGE_URL="https://miztv.top/stream/stream-622.php"
          echo "Installing Puppeteer..."
          npm i puppeteer --silent > /dev/null 2>&1
          
          echo "Launching browser to find the iframe source URL..."
          NEW_BASE_URL=$(node -e "
            const puppeteer = require('puppeteer');
            (async () => {
              const browser = await puppeteer.launch({ args: ['--no-sandbox', '--disable-setuid-sandbox'] });
              const page = await browser.newPage();
              try {
                await page.goto('${SOURCE_PAGE_URL}', { waitUntil: 'domcontentloaded', timeout: 30000 });
                await page.waitForSelector('iframe', { timeout: 15000 });
                const iframeSrc = await page.evaluate(() => document.querySelector('iframe').src);
                if (iframeSrc) {
                  const url = new URL(iframeSrc);
                  console.log(url.origin + '/'); // Επιστρέφει π.χ. https://allupplay.xyz/
                }
              } catch (e) {
                // Αποτυχία σημαίνει ότι θα επιστρέψει κενό string
              } finally {
                await browser.close();
              }
            })();
          ")

          if [ -z "$NEW_BASE_URL" ]; then
            echo "::error::Could not extract the new Referer/Origin URL."
            exit 1
          fi

          echo "Successfully extracted new base URL: $NEW_BASE_URL"

          # --- Βήμα 2: Απλή και ισχυρή αντικατάσταση ---
          TARGET_FILE="GreekSportsChannels.m3u8"
          
          echo "Updating all links in $TARGET_FILE to use the new Referer/Origin."

          # Αυτή η εντολή sed κάνει όλη τη μαγεία:
          # Βρίσκει κάθε γραμμή που περιέχει το βασικό μοτίβο του URL...
          # ...και αντικαθιστά τα πάντα από το # και μετά με το νέο, σωστό Referer & Origin.
          # Αν δεν υπάρχει #, το προσθέτει.
          sed -i -E "s|(#.*)?$|#Referer=${NEW_BASE_URL}&Origin=${NEW_BASE_URL}|" "$TARGET_FILE"

          echo "File updated successfully."


      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ci: Automate update of Referer/Origin URL'
          commit_user_name: 'GitHub Actions Bot'
          commit_user_email: 'actions@github.com'
          commit_author: 'GitHub Actions Bot <actions@github.com>'
          file_pattern: 'GreekSportsChannels.m3u8'
