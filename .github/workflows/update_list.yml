name: OS Mio 4K Streamlink Generator

on:
  schedule:
    - cron: '0 */3 * * *' # Τρέχει κάθε 3 ώρες (γιατί τα tokens λήγουν)
  workflow_dispatch:      # Χειροκίνητη εκκίνηση

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install requests

      - name: Scrape Data
        id: scrape
        run: |
          RAW_DATA=$(python find_and_auth.py)
          if [ "$RAW_DATA" == "FAILED" ]; then echo "Scraping failed"; exit 1; fi
          
          echo "token=$(echo $RAW_DATA | cut -d'|' -f1)" >> $GITHUB_OUTPUT
          echo "referer=$(echo $RAW_DATA | cut -d'|' -f2)" >> $GITHUB_OUTPUT
          echo "origin=$(echo $RAW_DATA | cut -d'|' -f3)" >> $GITHUB_OUTPUT

      - name: Generate M3U8 File
        env:
          TOKEN: ${{ steps.scrape.outputs.token }}
          REFERER: ${{ steps.scrape.outputs.referer }}
          ORIGIN: ${{ steps.scrape.outputs.origin }}
        run: |
          FILE="GreekSportsChannels.m3u8"
          echo "#EXTM3U" > $FILE
          
          # 1. Cosmote Sport 1 έως 9 (Σωστή σειρά)
          for i in {622..630}; do
            CH_NUM=$((i-621))
            ID="premium$i"
            echo "#EXTINF:-1,Cosmote Sport $CH_NUM HD" >> $FILE
            echo "http://127.0.0.1:8088/https://dokko1new.kiko2.ru/dokko1/$ID/mono.css -http-header=Origin=${ORIGIN} -http-header=Referer=${REFERER} -http-header=X-Channel-Key=$ID -http-header=Authorization=Bearer+${TOKEN}" >> $FILE
          done

          # 2. Nova Sports Prime & Start
          echo "#EXTINF:-1,Nova Sports Prime HD" >> $FILE
          echo "http://127.0.0.1:8088/https://dokko1new.kiko2.ru/dokko1/premium638/mono.css -http-header=Origin=${ORIGIN} -http-header=Referer=${REFERER} -http-header=X-Channel-Key=premium638 -http-header=Authorization=Bearer+${TOKEN}" >> $FILE
          
          echo "#EXTINF:-1,Nova Sports Start HD" >> $FILE
          echo "http://127.0.0.1:8088/https://dokko1new.kiko2.ru/dokko1/premium637/mono.css -http-header=Origin=${ORIGIN} -http-header=Referer=${REFERER} -http-header=X-Channel-Key=premium637 -http-header=Authorization=Bearer+${TOKEN}" >> $FILE

          # 3. Nova Sports 1 έως 6
          for i in {631..636}; do
            CH_NUM=$((i-630))
            ID="premium$i"
            echo "#EXTINF:-1,Nova Sports $CH_NUM HD" >> $FILE
            echo "http://127.0.0.1:8088/https://dokko1new.kiko2.ru/dokko1/$ID/mono.css -http-header=Origin=${ORIGIN} -http-header=Referer=${REFERER} -http-header=X-Channel-Key=$ID -http-header=Authorization=Bearer+${TOKEN}" >> $FILE
          done

          # 4. Nova Premier League
          echo "#EXTINF:-1,Nova Sports Premier League HD" >> $FILE
          echo "http://127.0.0.1:8088/https://windnew.kiko2.ru/wind/premium599/mono.css -http-header=Origin=${ORIGIN} -http-header=Referer=${REFERER} -http-header=X-Channel-Key=premium599 -http-header=Authorization=Bearer+${TOKEN}" >> $FILE

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: '✨ Updated Sports List (Fixed Order & Headers)'
          file_pattern: 'GreekSportsChannels.m3u8'
